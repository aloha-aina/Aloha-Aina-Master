---
title: "Graphs of Climate Change SWMM Results"
author: "Elmera Azadpour"
date: "1/24/2022"
output:
  pdf_document: default
subtitle: "This is code to analyze the climate change scaled results from SWMM and create figures"
---
NOTE: Figures will be be hidden from knitted markdown.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse) #For data wrangling
library(here)
library(hydroGOF)
library(stargazer)
library(kableExtra) # for knitting to html
library(gganimate) # for creating gif of simulated and observed discharge with MCF applied
options(scipen=999)
```
# Analysis of simulated vs observed runoff 
```{r, fig.show='hide', message = FALSE, warning = FALSE, results = 'hide'}
#Graph observed vs simulated runoff for Max Multiplicative Change Factor (MCF)

observed<- read.csv(here("climate_change_data","SWMM_results", "Mar14_observed.csv"))
simulated_max_march14 <- read.csv(here("climate_change_data","SWMM_results", "MCF_max_Mar14_simulated.csv"))
simulated_min_march14 <- read.csv(here("climate_change_data","SWMM_results", "MCF_min_Mar14_simulated.csv"))

# merge MCF max with observed
discharge_MCF_max<- merge(observed, simulated_max_march14, by = "time_step")

#merge MCF min with observed
discharge_MCF_min<- merge(observed, simulated_min_march14, by = "time_step")


summary(discharge_MCF_max)

graph_max<- ggplot(discharge_MCF_max, aes(x=discharge_obs_cfs, simulated_flow_cfs))+
  geom_point()

graph_max

graph_min<- ggplot(discharge_MCF_min, aes(x=discharge_obs_cfs, simulated_flow_cfs))+
  geom_point()

graph_min
  
calibrate_graph_max<- discharge_MCF_max %>% 
  ggplot()+
  geom_line(aes(x=time_step, y=discharge_obs_cfs), color="#000000", size = 2.5)+
  geom_line(aes(x=time_step, y=simulated_flow_cfs), color= "#009E73", size = 2.5)+
  theme_classic()+
  labs(x="Time (hours)", y="Discharge (cfs)")+
  scale_y_continuous(limits= c(0,850), breaks= seq(0,850, by= 100),expand= c(0,0))+
  scale_x_continuous(limits= c(0,12), breaks= seq(0,12, by= 2),expand= c(0,0))+
  annotate("text", label= "Observed", x=10.5, y=85, size=8)+
  annotate("text", label= "Simulated", x=10.5, y=300, size=8) +
  theme(text = element_text(size=22)) 

calibrate_graph_max  

calibrate_graph_min<- discharge_MCF_min %>% 
  ggplot()+
  geom_line(aes(x=time_step, y=discharge_obs_cfs), color="#000000", size =2.5) +
  geom_line(aes(x=time_step, y=simulated_flow_cfs), color= "#009E73", size =2.5)+
  theme_classic()+
  labs(x="Time (hours)", y="Discharge (cfs)")+
  scale_y_continuous(limits= c(0,400), breaks= seq(0,350, by= 50),expand= c(0,0))+
  scale_x_continuous(limits= c(0,12), breaks= seq(0,12, by= 2),expand= c(0,0))+
  annotate("text", label= "Simulated", x=10.5, y=45, size=8)+
  annotate("text", label= "Observed", x=10.5, y=185, size=8) +
    theme(text = element_text(size=22)) 
 

calibrate_graph_min 


# save graphs
 # ggsave('discharge_mar14_max_MCF.png', calibrate_graph_max, width = 16, height = 9, units = "in")

# ggsave('discharge_mar14_min_MCF.png', calibrate_graph_min, width = 16, height = 9, units = "in")


## combine all three lines onto one graph for easabilty 
calibrate_graph <- ggplot()+
  geom_line(data = discharge_MCF_min, aes(x=time_step, y=discharge_obs_cfs), color="#000000", size =2.5) +
  geom_line(data= discharge_MCF_min, aes(x=time_step, y=simulated_flow_cfs), color= "#009E73", size =2.5)+
  geom_line(data= discharge_MCF_max, aes(x=time_step, y=simulated_flow_cfs), color= "#D55E00", size = 2.5) +
  theme_classic()+
  labs(x="Time (hours)", y="Discharge (cfs)")+
  scale_y_continuous(limits= c(0,850), breaks= seq(0,850, by= 100),expand= c(0,0))+
  scale_x_continuous(limits= c(0,12), breaks= seq(0,12, by= 2),expand= c(0,0))+
  annotate("text", label= "Observed", x=10.5, y=200, size=8)+
  annotate("text", label= "Max MCF Simulated", x=10.5, y=655, size=8) +
   annotate("text", label= "Min MCF Simulated", x=10.5, y=55, size=8) + 
  theme(text = element_text(size=22)) 

calibrate_graph

# ggsave('discharge_mar14_MCF.png', calibrate_graph, width = 16, height = 9, units = "in")


calibrate_graph_animate <- ggplot()+
  geom_line(data = discharge_MCF_min, aes(x=time_step, y=discharge_obs_cfs), color="#000000", size =2.5) +
  geom_line(data= discharge_MCF_min, aes(x=time_step, y=simulated_flow_cfs), color= "#009E73", size =2.5)+
  geom_line(data= discharge_MCF_max, aes(x=time_step, y=simulated_flow_cfs), color= "#D55E00", size = 2.5) +
  theme_classic()+
  labs(x="Time (hours)", y="Discharge (cfs)")+
  scale_y_continuous(limits= c(0,850), breaks= seq(0,850, by= 100),expand= c(0,0))+
  scale_x_continuous(limits= c(0,12), breaks= seq(0,12, by= 2),expand= c(0,0))+
  annotate("text", label= "Observed", x=10.5, y=200, size=9)+
  annotate("text", label= "Max MCF Simulated", x=10.5, y=655, size=9) +
   annotate("text", label= "Min MCF Simulated", x=10.5, y=55, size=9) + 
  theme(text = element_text(size=25)) +
    transition_reveal(time_step)
calibrate_graph_animate

# animate in a two step process:
 animate(calibrate_graph_animate, height = 900, width =1000, renderer = gifski_renderer(loop = FALSE), bg = 'transparent')
 # anim_save("calibrate_graph_animate.gif")
```

## Analysis of MCF max storm results
```{r,fig.show='hide', message = FALSE, warning = FALSE, results = 'hide'}
subcatch_max_mcf<- read_csv("subcatchments_all.csv") %>% 
  mutate(subcatchment= OBJECTID_1) %>% 
  select(subcatchment, Curve_Number, Slope, percent_imp, Area_sqft)

swm_results_max_mcf<-read_csv("Wailupe_MCF_Max_Mar14.csv") 

#Characterize results by urbanization level
results_max_mcf<- merge(subcatch_max_mcf, swm_results_max_mcf, by = "subcatchment") %>% 
  mutate(runoff_normalized= 
           total_runoff_in/Area_sqft) %>% 
  mutate(Urbanization_level= 
           case_when(
             percent_imp <15 |percent_imp == 15 ~ "Natural (less than 15 % Impervious)",
             percent_imp >15 & percent_imp <45 ~ "Urbanized (Between 15 and 45 % Impervious)",
             percent_imp >44.9999 ~ "Very urbanized (More than 45 % Impervious)"
             )
           )

write.csv(results_max_mcf, file = "results_max_mcf.csv") ##Export as .csv for use with graph maps

## normalize peak discharge (cfs) for max MCF by dividing by subcatchment area 
results_max_mcf_normalized <- results_max_mcf %>% 
  mutate(peak_runoff_cfs_norm = peak_runoff_cfs/Area_sqft)

results_maxmcf_peakflow_table <- results_max_mcf %>% 
  select(subcatchment, peak_runoff_cfs, Curve_Number, Slope, percent_imp, Area_sqft) %>% 
  filter(!subcatchment %in% c(1, 2,94,3,38, 24)) %>% 
  arrange(desc(peak_runoff_cfs)) %>% 
  top_n(20,peak_runoff_cfs) %>% 
  kable(col.names=c("Subcatchment","Peak Runoff (cfs), Max MCF", 
                                "Curve Number", "Slope", 
                                "Percent Impervious", "Area (sqft)")) %>% 
  kable_styling(bootstrap_options = "striped")

results_maxmcf_peakflow_table

results_maxmcf_peakflow_table_normalized <- results_max_mcf_normalized %>% 
  select(subcatchment, peak_runoff_cfs, Curve_Number, Slope, percent_imp, Area_sqft,peak_runoff_cfs_norm ) %>% 
  filter(!subcatchment %in% c(1, 2,94,3,38, 24)) %>% 
  arrange(desc(peak_runoff_cfs_norm)) %>% 
  top_n(20,peak_runoff_cfs_norm) %>% 
  kable(col.names=c("Subcatchment","Peak Runoff (cfs), Max MCF", 
                                "Curve Number", "Slope", 
                                "Percent Impervious", "Area (sqft)", "Normalized Peak Runoff (cfs/sqft)")) %>% 
  kable_styling(bootstrap_options = "striped")

results_maxmcf_peakflow_table_normalized

results_maxmcf_runoffcoef_table <- results_max_mcf %>% 
  select(subcatchment, runoff_coeff, Curve_Number, Slope, percent_imp, Area_sqft) %>% 
  filter(!subcatchment %in% c(1, 2,94,3,38, 24)) %>% 
  arrange(desc(runoff_coeff)) %>% 
  top_n(20,runoff_coeff) %>% 
  kable(col.names=c("Subcatchment","Runoff Coefficient, Max MCF", 
                                "Curve Number", "Slope", 
                                "Percent Impervious", "Area (sqft)")) %>% 
  kable_styling(bootstrap_options = "striped")

results_maxmcf_runoffcoef_table

#Perform a linear regression for the SWMM max MCF storm results
results_max_mcf_regression<- lm(total_runoff_in ~Curve_Number + Slope + percent_imp + 
                              Area_sqft, data = results_max_mcf)

#Graph the relationship bw simulated runoff and impervious cover by urbanization level
runoff_imp_graph_max_mcf<- results_max_mcf %>% 
  ggplot(aes(x=percent_imp, y=total_runoff_in))+
  geom_point(aes(color=Urbanization_level))+
  labs(x= "Percent Impervious of Subcatchment", y= "Total Simulated Runoff (inches)")+
  scale_y_continuous(limits= c(0,8), breaks= seq(0,8, by= 1),expand= c(0,0.08))+
  scale_x_continuous(limits= c(0,80), breaks= seq(0,80, by= 10),expand= c(0,0))+
  scale_color_manual(name= "Urbanization Level", values= c("darkgreen", "darkseagreen", 
                                                           "darkgoldenrod1"))+
  theme_classic()

runoff_imp_graph_max_mcf

#Save runoff vs. impervious graph
# ggsave("runoff_imp_max_mcf.pdf", width = 8, height =4)
# ggsave("runoff_imp_max_mcf.png", width = 8, height =4)

#Create a table for the regression results for max mcf storm 
regress_table_max_mcf<- stargazer(results_max_mcf_regression, type ="html", digits= 2,
                          dep.var.labels = "Total Runoff (Inches)",
                       covariate.labels = c("Curve Number", "Slope", "Percent Impervious",
                                            "Area (sqft)", "Y-Intercept"),
                       omit.stat = c("rsq"))
regress_table_max_mcf

```


## Analysis of MCF min storm results
```{r,fig.show='hide', message = FALSE, warning = FALSE, results = 'hide'}
subcatch_min_mcf<- read_csv("subcatchments_all.csv") %>% 
  mutate(subcatchment= OBJECTID_1) %>% 
  select(subcatchment, Curve_Number, Slope, percent_imp, Area_sqft)

swm_results_min_mcf<-read_csv("Wailupe_MCF_Min_Mar14.csv") 

#Characterize results by urbanization level
results_min_mcf<- merge(subcatch_min_mcf, swm_results_min_mcf, by = "subcatchment") %>% 
  mutate(runoff_normalized= 
           total_runoff_in/Area_sqft) %>% 
  mutate(Urbanization_level= 
           case_when(
             percent_imp <15 |percent_imp == 15 ~ "Natural (less than 15 % Impervious)",
             percent_imp >15 & percent_imp <45 ~ "Urbanized (Between 15 and 45 % Impervious)",
             percent_imp >44.9999 ~ "Very urbanized (More than 45 % Impervious)"
             )
           )

write.csv(results_min_mcf, file = "results_min_mcf.csv") ##Export as .csv for use with graph maps


## normalize peak discharge (cfs) for min MCF by dividing by subcatchment area 
results_min_mcf_normalized <- results_min_mcf %>% 
  mutate(peak_runoff_cfs_norm = peak_runoff_cfs/Area_sqft)

results_minmcf_peakflow_table <- results_min_mcf %>% 
  select(subcatchment, peak_runoff_cfs, Curve_Number, Slope, percent_imp, Area_sqft) %>% 
  filter(!subcatchment %in% c(1, 2,94,3,38, 24)) %>% 
  arrange(desc(peak_runoff_cfs)) %>% 
  top_n(20,peak_runoff_cfs) %>% 
  kable(col.names=c("Subcatchment","Peak Runoff (cfs), Min MCF", 
                                "Curve Number", "Slope", 
                                "Percent Impervious", "Area (sqft)")) %>% 
  kable_styling(bootstrap_options = "striped")

results_minmcf_peakflow_table

results_minmcf_peakflow_normalized_table <- results_min_mcf_normalized %>% 
  select(subcatchment, peak_runoff_cfs, Curve_Number, Slope, percent_imp, Area_sqft,peak_runoff_cfs_norm ) %>% 
  filter(!subcatchment %in% c(1, 2,94,3,38, 24)) %>% 
  arrange(desc(peak_runoff_cfs_norm)) %>% 
  top_n(20,peak_runoff_cfs_norm) %>% 
  kable(col.names=c("Subcatchment","Peak Runoff (cfs), Min MCF", 
                                "Curve Number", "Slope", 
                                "Percent Impervious", "Area (sqft)", "Normalized Peak Runoff (cfs/sqft)")) %>% 
  kable_styling(bootstrap_options = "striped")

results_minmcf_peakflow_normalized_table

results_minmcf_runoffcoef_table <- results_min_mcf %>% 
  select(subcatchment, runoff_coeff, Curve_Number, Slope, percent_imp, Area_sqft) %>% 
  filter(!subcatchment %in% c(1, 2,94,3,38, 24)) %>% 
  arrange(desc(runoff_coeff)) %>% 
  top_n(20,runoff_coeff) %>% 
  kable(col.names=c("Subcatchment","Runoff Coefficient, Min MCF", 
                                "Curve Number", "Slope", 
                                "Percent Impervious", "Area (sqft)")) %>% 
  kable_styling(bootstrap_options = "striped")

results_minmcf_runoffcoef_table


#Perform a linear regression for the SWMM max MCF storm results
results_min_mcf_regression<- lm(total_runoff_in ~Curve_Number + Slope + percent_imp + 
                              Area_sqft, data = results_min_mcf)

#Graph the relationship bw simulated runoff and impervious cover by urbanization level
runoff_imp_graph_min_mcf<- results_min_mcf %>% 
  ggplot(aes(x=percent_imp, y=total_runoff_in))+
  geom_point(aes(color=Urbanization_level))+
  labs(x= "Percent Impervious of Subcatchment", y= "Total Simulated Runoff (inches)")+
  scale_y_continuous(limits= c(0,7), breaks= seq(0,7, by= 1),expand= c(0,0.08))+
  scale_x_continuous(limits= c(0,80), breaks= seq(0,80, by= 10),expand= c(0,0))+
  scale_color_manual(name= "Urbanization Level", values= c("darkgreen", "darkseagreen", 
                                                           "darkgoldenrod1"))+
  theme_classic()

runoff_imp_graph_min_mcf

#Save runoff vs. impervious graph
# ggsave("runoff_imp_min_mcf.pdf", width = 8, height =4)
# ggsave("runoff_imp_min_mcf.png", width = 8, height =4)

#Create a table for the regression results
regress_table_min_mcf<- stargazer(results_min_mcf_regression, type ="html", digits= 2,
                          dep.var.labels = "Total Runoff (Inches)",
                       covariate.labels = c("Curve Number", "Slope", "Percent Impervious",
                                            "Area (sqft)", "Y-Intercept"),
                       omit.stat = c("rsq"))
regress_table_min_mcf
```
## Maps of SWMM Results
```{r, include = FALSE}
### Code setup - Load packages
library(sf) #For shapefiles
library(tmap) #For mapmaking
library(tmaptools) #For mapmaking
library(janitor) #For cleaning names
library(RColorBrewer) # for binning color gradient
library(metR) # for binning color gradient
```

###  Maps for MCF max storm hotspots
```{r, fig.show='hide', message = FALSE, warning = FALSE, results = 'hide'}

results_max_mcf<- read_csv("results_max_mcf.csv") ##read in file from code above

#Combine subcatchments outline with wet storm results
subcatch_max <- read_sf(dsn = here("climate_change_data", "SWMM_results","shapefiles"), layer = "subcatch_outline") %>%
  st_transform(st_crs(4326)) %>% 
  clean_names() %>% 
  select(subcatchment = objectid_1) %>% 
  merge(results_max_mcf) %>% 
   filter(subcatchment != "5")

#  Total volume hotspots  
hotspots_max_mcf_total <- tm_basemap("OpenStreetMap.Mapnik") +
  tm_shape(subcatch_max, unit = "Miles") +
  tm_polygons("runoff_coeff", alpha = 0.8, palette = "Blues", style = "cont", n=8, 
              legend.hist = TRUE, title = "Runoff Coefficient") +
  tm_layout(title = "March 2009 Max MCF storm", inner.margins=c(.05, .05, 0.1, .53), 
            legend.position =  c(.6,.32), legend.title.size = 1.4, legend.text.size = 1) +
  tm_text("subcatchment", size = 0.3) +
  tm_scale_bar(position = c(.6,.59), breaks = c(0, 0.2, 0.4, 0.6, 0.8,1)) +
  tm_compass(position = c(.58,.52))

# tmap_save(hotspots_max_mcf_total, here("climate_change_data", "output_maps","hotspots_mcf_max.png")) ##  not exporting


#  Peak flow hotspots
hotspots_max_mcf_peak <- tm_basemap("OpenStreetMap.Mapnik") +
  tm_shape(subcatch_max, unit = "Miles") +
  tm_polygons("peak_runoff_cfs", alpha = 0.75, palette = "Greens", style = "cont", n=8, 
              legend.hist = TRUE, title = "Peak Discharge (cfs)") +
  tm_layout(title = "March 2009 Max MCF storm", inner.margins=c(.05, .05, 0.1, .53), 
            legend.position =  c(.6,.27), legend.title.size = 1.4, legend.text.size = 1) +
  tm_text("subcatchment", size = 0.3) +
  tm_scale_bar(position = c(.6,.54), breaks = c(0, 0.2, 0.4, 0.6, 0.8,1)) +
  tm_compass(position = c(.58,.47))
#tmap_save(hotspots_max_mcf_peak, here("climate_change_data", "output_maps","hotspots_max_mcf_peak.png"))

subcatch_max_peak <- subcatch_max %>% 
  filter(!subcatchment %in% c(1, 2,94,3,38, 24)) %>% 
  ggplot() +
  geom_sf(aes(fill = peak_runoff_cfs)) +
  theme_bw() + 
  scale_fill_gradient(low = "#D1F2EB", high = "#148F77", name = "Peak Discharge (cfs)",
                      breaks = c(0, 25, 50, 75, 100 )) +
  labs(title = "Max MCF") +
  geom_sf_text(aes(label = subcatchment), colour = "black", fontface = "bold", size = 1.8) +
  # geom_sf_label(aes(label = subcatchment), size = 1.5) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
theme(axis.text.x = element_text(angle = 90))+ 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank(),
        panel.border=element_blank()) +
  theme_void() # for faculty presentation, remove lines and axis elements 

subcatch_max_peak

# ggsave('subcatch_max_peak_removedsubs_themevoid.png', subcatch_max_peak, width = 5, height = 7, units = "in")

subcatch_max_total <- subcatch_max %>%
  filter(!subcatchment %in% c(1, 2,94,3,38, 24)) %>% 
  ggplot() +
  geom_sf(aes(fill = runoff_coeff)) +
  theme_bw() + 
  scale_fill_gradient(low = "#D6EAF8", high = "#2874A6", name = "Runoff Coefficient",
                      breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1.0),
                      limits = c(0,1.0)) +
  labs(title = "Max MCF") +
  geom_sf_text(aes(label = subcatchment), colour = "black", fontface = "bold", size = 1.8) +
  # geom_sf_label(aes(label = subcatchment), size = 1.5) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
theme(axis.text.x = element_text(angle = 90)) +
    theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank(),
        panel.border=element_blank()) +
  theme_void()

subcatch_max_total

  #  ggsave('subcatch_max_total.png', subcatch_max_total, width = 5, height = 7, units = "in")


```

###  Maps for MCF min storm hotspots
```{r, fig.show='hide', message = FALSE, warning = FALSE, results = 'hide'}

results_min_mcf<- read_csv("results_min_mcf.csv") ##read in file from code above

#Combine subcatchments outline with wet storm results
subcatch_min <- read_sf(dsn = here("climate_change_data", "SWMM_results","shapefiles"), layer = "subcatch_outline") %>%
  st_transform(st_crs(4326)) %>% 
  clean_names() %>% 
  select(subcatchment = objectid_1) %>% 
  merge(results_min_mcf) %>% 
   filter(subcatchment != "5")

#  Total volume hotspots  
hotspots_min_mcf_total <- tm_basemap("OpenStreetMap.Mapnik") +
  tm_shape(subcatch_min, unit = "Miles") +
  tm_polygons("runoff_coeff", alpha = 0.8, palette = "Blues", style = "cont", n=8, 
              legend.hist = TRUE, title = "Runoff Coefficient") +
  tm_layout(title = "March 2009 Min MCF storm", inner.margins=c(.05, .05, 0.1, .53), 
            legend.position =  c(.6,.32), legend.title.size = 1.4, legend.text.size = 1) +
  tm_text("subcatchment", size = 0.3) +
  tm_scale_bar(position = c(.6,.59), breaks = c(0, 0.2, 0.4, 0.6, 0.8,1)) +
  tm_compass(position = c(.58,.52))
##tmap_save(hotspots_wet_total, here("5.Results_Maps", "output_maps","hotspots_wet_total.png"))


#  Peak flow hotspots
hotspots_min_mcf_peak <- tm_basemap("OpenStreetMap.Mapnik") +
  tm_shape(subcatch_min, unit = "Miles") +
  tm_polygons("peak_runoff_cfs", alpha = 0.75, palette = "Greens", style = "cont", n=8, 
              legend.hist = TRUE, title = "Peak Discharge (cfs)") +
  tm_layout(title = "March 2009 Min MCF storm", inner.margins=c(.05, .05, 0.1, .53), 
            legend.position =  c(.6,.27), legend.title.size = 1.4, legend.text.size = 1) +
  tm_text("subcatchment", size = 0.3) +
  tm_scale_bar(position = c(.6,.54), breaks = c(0, 0.2, 0.4, 0.6, 0.8,1)) +
  tm_compass(position = c(.58,.47))
##tmap_save(hotspots_wet_peak, here("5.Results_Maps", "output_maps","hotspots_wet_peak.png"))

subcatch_min_peak <- subcatch_min %>%
  filter(!subcatchment %in% c(1, 2,94,3,38, 24))  %>% 
  ggplot() +
  geom_sf(aes(fill = peak_runoff_cfs)) +
  theme_classic()+ 
  scale_fill_gradient(low = "#D1F2EB", high = "#148F77", name = "Peak Discharge (cfs)",
                      breaks = c(0, 3, 6, 9, 12, 15)) +
  labs(title = "Min MCF") +
  geom_sf_text(aes(label = subcatchment), colour = "black", fontface = "bold", size = 1.8) +
  # geom_sf_label(aes(label = subcatchment), size = 1.5) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
theme(axis.text.x = element_text(angle = 90)) + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank(),
        panel.border=element_blank()) +
  theme_void() # for facily presentation, remove lines and axis elements 

subcatch_min_peak

 # ggsave('subcatch_min_peak_removedsub_themevoid.png', subcatch_min_peak, width = 5, height = 7, units = "in")

subcatch_min_total <- subcatch_min %>%
  filter(!subcatchment %in% c(1, 2,94,3,38, 24)) %>% 
  ggplot() +
  geom_sf(aes(fill = runoff_coeff)) +
  theme_bw() + 
  scale_fill_gradient(low = "#D6EAF8", high = "#2874A6", name = "Runoff Coefficient",
                      breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1.0),
                      limits = c(0,1.0)) +
  labs(title = "Min MCF") +
  geom_sf_text(aes(label = subcatchment), colour = "black", fontface = "bold", size = 1.8) +
  # geom_sf_label(aes(label = subcatchment), size = 1.5) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
theme(axis.text.x = element_text(angle = 90)) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank(),
        panel.border=element_blank()) +
  theme_void()

subcatch_min_total

# ggsave('subcatch_min_total.png', subcatch_min_total, width = 5, height = 7, units = "in")

```

## Normalized Peak Discharge Maps 
```{r, fig.show='hide', message = FALSE, warning = FALSE, results = 'hide'}
subcatch_max_normalized <- read_sf(dsn = here("climate_change_data", "SWMM_results","shapefiles"), layer = "subcatch_outline") %>%
  st_transform(st_crs(4326)) %>% 
  clean_names() %>% 
  select(subcatchment = objectid_1) %>% 
  merge(results_max_mcf_normalized) %>% 
   filter(subcatchment != "5")

## normalized Max MCF Peak Discharge
subcatch_max_peak_normalized <- subcatch_max_normalized %>% 
  filter(!subcatchment %in% c(1, 2,94,3,38, 24)) %>% 
  ggplot() +
  geom_sf(aes(fill = peak_runoff_cfs_norm)) +
  theme_bw() + 
  scale_fill_gradient(low = "#D1F2EB", high = "#148F77", name = "Normalized Peak Discharge (cfs/sqft)") +
  labs(title = "Max MCF") +
  geom_sf_text(aes(label = subcatchment), colour = "black", fontface = "bold", size = 1.8) +
  # geom_sf_label(aes(label = subcatchment), size = 1.5) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
theme(axis.text.x = element_text(angle = 90))+ 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank(),
        panel.border=element_blank()) +
  theme_void() # for faculty presentation, remove lines and axis elements 

subcatch_max_peak_normalized

# ggsave('subcatch_max_peak_removedsubs_themevoid_norm.png', subcatch_max_peak_normalized, width = 5, height = 7, units = "in")

subcatch_min_normalized <- read_sf(dsn = here("climate_change_data", "SWMM_results","shapefiles"), layer = "subcatch_outline") %>%
  st_transform(st_crs(4326)) %>% 
  clean_names() %>% 
  select(subcatchment = objectid_1) %>% 
  merge(results_min_mcf_normalized) %>% 
   filter(subcatchment != "5")

## normalized Min MCF Peak Discharge
subcatch_min_peak_normalized <- subcatch_min_normalized %>%
  filter(!subcatchment %in% c(1, 2,94,3,38, 24))  %>% 
  ggplot() +
  geom_sf(aes(fill = peak_runoff_cfs_norm)) +
  theme_classic()+ 
  scale_fill_gradient(low = "#D1F2EB", high = "#148F77", name = "Normalized Peak Discharge (cfs/sqft)") +
  labs(title = "Min MCF") +
  geom_sf_text(aes(label = subcatchment), colour = "black", fontface = "bold", size = 1.8) +
  # geom_sf_label(aes(label = subcatchment), size = 1.5) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
theme(axis.text.x = element_text(angle = 90)) + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank(),
        panel.border=element_blank()) +
  theme_void() # for facily presentation, remove lines and axis elements 

subcatch_min_peak_normalized

 # ggsave('subcatch_min_peak_removedsub_themevoid_norm.png', subcatch_min_peak_normalized, width = 5, height = 7, units = "in")
```
## binned runoff coefficient maps for min and max MCF 
```{r, fig.show='hide', message = FALSE, warning = FALSE, results = 'hide'}
# View a single RColorBrewer palette by specifying its name
display.brewer.pal(n = 7, name = 'Blues')
# Hexadecimal color specification
brewer.pal(n = 7, name = "Blues")


mycols <- brewer.pal(n = 11, name = "Blues")
mybreaks_max<- c(0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9)

subcatch_min_total <- subcatch_min %>%
  filter(!subcatchment %in% c(1, 2,94,3,38, 24)) %>%
  mutate(runoff_coeff_cut = cut_number(runoff_coeff, n = 10)) %>%
  ggplot() +
  geom_sf(aes(fill = runoff_coeff_cut)) +
  theme_bw()  +
  scale_fill_gradientn(colours = mycols,
                       breaks= mybreaks_max,
    super = metR::ScaleDiscretised,
    name = "Runoff Coefficient") +
  theme(legend.position = "bottom") +
  labs(title = "Min MCF") +
  geom_sf_text(aes(label = subcatchment), colour = "black", fontface = "bold", size = 3.1) +
  # geom_sf_label(aes(label = subcatchment), size = 1.5) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
theme(axis.text.x = element_text(angle = 90)) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank(),
        panel.border=element_blank()) +
  theme_void()

subcatch_min_total

  # ggsave('subcatch_min_total_binned.png', subcatch_min_total, width = 5, height = 7, units = "in")

mycols <- brewer.pal(n = 11, name = "Blues")
mybreaks_max<- c(0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9)

subcatch_max_total <- subcatch_max %>%
  filter(!subcatchment %in% c(1, 2,94,3,38, 24)) %>%
  mutate(runoff_coeff_cut = cut_number(runoff_coeff, n = 10)) %>%
  ggplot() +
  geom_sf(aes(fill = runoff_coeff_cut)) +
  theme_bw()  +
  scale_fill_gradientn(colours = mycols,
                       breaks= mybreaks_max,
    super = metR::ScaleDiscretised,
    name = "Runoff Coefficient") +
  labs(title = "Max MCF") +
  geom_sf_text(aes(label = subcatchment), colour = "black", fontface = "bold", size = 3.1) +
  # geom_sf_label(aes(label = subcatchment), size = 1.5) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
theme(axis.text.x = element_text(angle = 90)) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank(),
        panel.border=element_blank()) +
  theme_void()

subcatch_max_total

 # ggsave('subcatch_max_total_binned.png', subcatch_max_total, width = 5, height = 7, units = "in")

```
## binned peak flow  maps for min and max MCF 
```{r, fig.show='hide', message = FALSE, warning = FALSE, results = 'hide'}
mycols2 <- brewer.pal(n = 11, name = "Greens")
mybreaks2_min<- c(0.0, 2.0, 4.0, 6.0, 8.0, 10.0, 12.0, 14.0, 16.0)

subcatch_min_peak <- subcatch_min %>%
  filter(!subcatchment %in% c(1, 2,94,3,38, 24))  %>%
  mutate(peak_runoff_cfs_cut = cut_number(peak_runoff_cfs, n = 11)) %>% 
  ggplot() +
  geom_sf(aes(fill = peak_runoff_cfs_cut)) +
  theme_classic()+
  scale_fill_gradientn(colours = mycols2,
                       breaks= mybreaks2_min,
    super = metR::ScaleDiscretised,
    name = "Peak Discharge (cfs)") +
  labs(title = "Min MCF") +
  geom_sf_text(aes(label = subcatchment), colour = "black", fontface = "bold", size = 3.1) +
  # geom_sf_label(aes(label = subcatchment), size = 1.5) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
theme(axis.text.x = element_text(angle = 90)) + 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank(),
        panel.border=element_blank()) +
  theme_void() # for facily presentation, remove lines and axis elements 

subcatch_min_peak

 # ggsave('subcatch_min_peak_removedsub_themevoid_binned.png', subcatch_min_peak, width = 5, height = 7, units = "in")

mycols3 <- brewer.pal(n = 11, name = "Greens")
mybreaks3_max<- c(0.0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100)

subcatch_max_peak <- subcatch_max %>% 
  filter(!subcatchment %in% c(1, 2,94,3,38, 24)) %>%
  mutate(peak_runoff_cfs_cut = cut_number(peak_runoff_cfs, n = 11)) %>% 
  ggplot() +
  geom_sf(aes(fill = peak_runoff_cfs_cut)) +
  theme_classic()+
  scale_fill_gradientn(colours = mycols3,
                       breaks= mybreaks3_max,
    super = metR::ScaleDiscretised,
    name = "Peak Discharge (cfs)") +
  labs(title = "Max MCF") +
  geom_sf_text(aes(label = subcatchment), colour = "black", fontface = "bold", size = 3.1) +
  # geom_sf_label(aes(label = subcatchment), size = 1.5) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
theme(axis.text.x = element_text(angle = 90))+ 
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        rect = element_blank(),
        panel.border=element_blank()) +
  theme_void() # for faculty presentation, remove lines and axis elements 

subcatch_max_peak

# ggsave('subcatch_max_peak_removedsubs_themevoid_binned.png', subcatch_max_peak, width = 5, height = 7, units = "in")

```
## combine max and min runoff coefficient results into single table showing the catchment #, min, and max runoff coefficient, slope, percent impervious, and area (sqft)
```{r,fig.show='hide', message = FALSE, warning = FALSE, results = 'hide'}
results_min_mcf_rc <- results_min_mcf %>%
  select(subcatchment, Slope, percent_imp, Area_sqft, runoff_coeff) %>%
  filter(!subcatchment %in% c(1, 2,94,3,38, 24)) %>%
  arrange(desc(runoff_coeff)) %>%
  top_n(20,runoff_coeff)

results_max_mcf_rc <- results_max_mcf %>%
  select(subcatchment, Slope, percent_imp, Area_sqft, runoff_coeff) %>%
  filter(!subcatchment %in% c(1, 2,94,3,38, 24)) %>%
  arrange(desc(runoff_coeff)) %>%
  top_n(20,runoff_coeff)

results_runoffcoef_table <- results_min_mcf_rc %>%
  full_join(results_max_mcf_rc, by=c("subcatchment", "Slope", "percent_imp", "Area_sqft")) %>%
  kable(col.names=c("Subcatchment","Slope", "Percent Impervious", "Area (sqft)", "Runoff Coefficient, Min MCF",
                                "Runoff Coefficient, Max MCF")) %>%
  kable_styling(bootstrap_options = "striped")

results_runoffcoef_table
```

## combine max and min peak runoff (cfs) results into single table showing the catchment #, min, and max peak runoff (cfs)
```{r,fig.show='hide', message = FALSE, warning = FALSE, results = 'hide'}
results_min_mcf_peak <- results_min_mcf %>%
  select(subcatchment, Slope, percent_imp, Area_sqft, peak_runoff_cfs) %>%
  filter(!subcatchment %in% c(1, 2,94,3,38, 24)) %>%
  arrange(desc(peak_runoff_cfs)) %>%
  top_n(20,peak_runoff_cfs)

results_max_mcf_peak <- results_max_mcf %>%
  select(subcatchment, Slope, percent_imp, Area_sqft, peak_runoff_cfs) %>%
  filter(!subcatchment %in% c(1, 2,94,3,38, 24)) %>%
  arrange(desc(peak_runoff_cfs)) %>%
  top_n(20,peak_runoff_cfs)

results_peakflow_table <- results_min_mcf_peak %>%
  full_join(results_max_mcf_peak, by=c("subcatchment", "Slope", "percent_imp", "Area_sqft")) %>%
  kable(col.names=c("Subcatchment","Slope", "Percent Impervious", "Area (sqft)","Peak Runoff (cfs), Min MCF",
                                "Peak Runoff (cfs), Max MCF")) %>%
  kable_styling(bootstrap_options = "striped")

results_peakflow_table
```

## comparing historical vs Max MCF runoff coeffiecients from Dornan et al., 2020
```{r, fig.show='hide', message = FALSE, warning = FALSE, results = 'hide'}
## runoff coefficients differences
dornan_results_top20_rc <- read_csv("~/Desktop/Aloha-Aina-Master/climate_change_data/SWMM_results/dornan_results_top20_rc.csv") %>% 
  select(subcatchment, runoff_coeff) # read in dorana et al RC results

results_max_mcf_rc_summary <- results_max_mcf_rc %>%  select(subcatchment, runoff_coeff) # select just our subcatchment and runoff coefficients to be able to subtract 

combined_rc_results <- dornan_results_top20_rc %>%  right_join(results_max_mcf_rc_summary, by = c("subcatchment")) # combine dornan results with our max MCF reslts 

combined_rc_results = combined_rc_results %>%  mutate(subtract = runoff_coeff.y-runoff_coeff.x) # add column with difference between max MCF rc results - dornan historical rc results with March 14, 09 storm 

## peak flow differences 
dornan_results_top20_peakflow <- read_csv("~/Desktop/Aloha-Aina-Master/climate_change_data/SWMM_results/dornan_results_top20_peakflow.csv") %>% 
  select(subcatchment, peak_runoff_cfs) # read in Team Kahuawais peak flow results

results_max_mcf_peak_summary <- results_max_mcf_peak %>%  select(subcatchment, peak_runoff_cfs) # select just our subcatchment and peak runoff cfs to be able to subtract 

combined_peak_results <- dornan_results_top20_peakflow %>%  right_join(results_max_mcf_peak_summary, by = c("subcatchment"))

combined_peak_results = combined_peak_results %>%  mutate(subtract = peak_runoff_cfs.y-peak_runoff_cfs.x)
```

