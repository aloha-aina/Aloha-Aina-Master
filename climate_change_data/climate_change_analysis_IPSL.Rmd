---
title: 'Climate Change Projections: IPSL-CM6A-LR'
author: "Elmera Azadpour"
date: "1/14/2022"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(lubridate)
library(ggpubr)
library(zoo)
library(scales)
library(ggplot2)
library(knitr)
```

## read in daily total climate projection and historical data exported from jupyter notebook, code can be found here: https://github.com/aloha-aina/Aloha-Aina-Master 
```{r, fig.show='hide', message = FALSE, warning = FALSE, results = 'hide', error = TRUE}
## Note: these data are from climate model IPSL-CM6A-LR (France)
## daily totals
ipsl_historical_tot = read.csv(here("climate_change_data", "IPSL_daily_tot","oahu_historical_1850_2014_total.csv")) %>%  
  rename(date = dayofyear, pcp = pr) 
ipsl_ssp126_tot = read.csv(here("climate_change_data","IPSL_daily_tot","oahu_ssp126_2015_2100_total.csv")) %>% 
  rename(date = dayofyear, pcp = pr) 
ipsl_ssp245_tot = read.csv(here("climate_change_data","IPSL_daily_tot","oahu_ssp245_2015_2100_total.csv")) %>% 
  rename(date = dayofyear, pcp = pr) 
ipsl_ssp370_tot = read.csv(here("climate_change_data","IPSL_daily_tot","oahu_ssp370_2015_2100_total.csv")) %>% 
  rename(date = dayofyear, pcp = pr)
ipsl_ssp585_tot = read.csv(here("climate_change_data","IPSL_daily_tot","oahu_ssp585_2015_2100_total.csv")) %>% 
  rename(date = dayofyear, pcp = pr)

ipsl_historical_tot$date <- ymd(ipsl_historical_tot$date)
ipsl_ssp126_tot$date <- ymd(ipsl_ssp126_tot$date)
ipsl_ssp245_tot$date <- ymd(ipsl_ssp245_tot$date)
ipsl_ssp370_tot$date <- ymd(ipsl_ssp370_tot$date)
ipsl_ssp585_tot$date <- ymd(ipsl_ssp585_tot$date)
```

## Daily total visualization 
```{r,fig.show='hide', message = FALSE, warning = FALSE, results = 'hide', error = TRUE}
ipsl_daily_tot_proj <- 
  ggplot() +
  geom_line(data = ipsl_historical_tot, aes(x=date, y=pcp, color= "black"), size = 0.5) + 
  geom_line(data = ipsl_ssp126_tot, aes(x=date, y=pcp, color="orange"), size = 0.5) + 
  geom_line(data = ipsl_ssp245_tot, aes(x=date, y=pcp, color="red"), size = 0.5) +
  geom_line(data = ipsl_ssp370_tot, aes(x=date, y=pcp, color = "blue"), size = 0.5) +
  geom_line(data = ipsl_ssp585_tot, aes(x=date, y=pcp, color = "seagreen"), size = 0.5) + 
  theme_minimal() + 
  scale_y_continuous(breaks=seq(0,150,10)) +
  scale_x_date(date_breaks = "20 years", date_labels = "%Y") +
  ggtitle("Oahu, HI Daily Total Precipitation, IPSL-CM6A-LR: 1850-2100") +
   labs(x = "Year",
       y = "Precipitation (in)") +
  scale_color_manual(values = c("black", "orange", "red", "blue", "seagreen", "purple"), 
                     labels = c("historical" , "spp126", "ssp245", "ssp370", "ssp585")) +
  theme(legend.title=element_blank())+
    theme(legend.position="bottom")

ipsl_daily_tot_proj
```
## daily totals by month 
```{r,fig.show='hide', message = FALSE, warning = FALSE, results = 'hide', error = TRUE}
# add seperate columns for year, month and day
ipsl_historical_tot <- ipsl_historical_tot %>% 
  mutate(year = year(date)) %>% 
  mutate(month = month(date)) %>% 
  mutate(day = day(date))

ipsl_ssp126_tot <- ipsl_ssp126_tot %>% 
  mutate(year = year(date)) %>% 
  mutate(month = month(date)) %>% 
  mutate(day = day(date))

ipsl_ssp245_tot <- ipsl_ssp245_tot %>% 
  mutate(year = year(date)) %>% 
  mutate(month = month(date)) %>% 
  mutate(day = day(date))

ipsl_ssp370_tot <- ipsl_ssp370_tot %>% 
  mutate(year = year(date)) %>% 
  mutate(month = month(date)) %>% 
  mutate(day = day(date))

ipsl_ssp585_tot <- ipsl_ssp585_tot  %>% 
  mutate(year = year(date)) %>% 
  mutate(month = month(date)) %>% 
  mutate(day = day(date))


# group by yearly sum of pcp 
ipsl_historical_tot_yearly <- ipsl_historical_tot %>% 
  group_by(year) %>% 
  mutate(sum = sum(pcp)) %>% 
  select(year, sum) %>% 
  distinct()

ipsl_historical_tot_yearly$year <- as.numeric(ipsl_historical_tot_yearly$year) 


# group by yearly sum of pcp 
ipsl_ssp126_tot_yearly <- ipsl_ssp126_tot %>% 
  group_by(year) %>% 
  mutate(sum = sum(pcp)) %>% 
  select(year, sum) %>% 
  distinct()

ipsl_ssp126_tot_yearly$year <- as.numeric(ipsl_ssp126_tot_yearly$year) 

# group by yearly sum of pcp 
ipsl_ssp245_tot_yearly <- ipsl_ssp245_tot %>% 
  group_by(year) %>% 
  mutate(sum = sum(pcp)) %>% 
  select(year, sum) %>% 
  distinct()

ipsl_ssp245_tot_yearly$year <- as.numeric(ipsl_ssp245_tot_yearly$year) 

# group by yearly sum of pcp 
ipsl_ssp370_tot_yearly <- ipsl_ssp370_tot %>% 
  group_by(year) %>% 
  mutate(sum = sum(pcp)) %>% 
  select(year, sum) %>% 
  distinct()

ipsl_ssp370_tot_yearly$year <- as.numeric(ipsl_ssp370_tot_yearly$year) 

# group by yearly sum of pcp 
ipsl_ssp585_tot_yearly <- ipsl_ssp585_tot %>% 
  group_by(year) %>% 
  mutate(sum = sum(pcp)) %>% 
  select(year, sum) %>% 
  distinct()

ipsl_ssp585_tot_yearly$year <- as.numeric(ipsl_ssp585_tot_yearly$year) 

# group by month (and associated year) sum of pcp
ipsl_historical_tot_monthly <- ipsl_historical_tot %>% 
  group_by(month,year) %>% 
  mutate(sum = sum(pcp)) %>% 
  select(month, year, sum) %>% 
  distinct()

ipsl_historical_tot_monthly$date <- format(as.Date(paste(ipsl_historical_tot_monthly$year, ipsl_historical_tot_monthly$month, 01), "%Y %m %d"), "%m-%Y")

ipsl_historical_tot_monthly$date <- my(ipsl_historical_tot_monthly$date)

# group by month (and associated year) sum of pcp
ipsl_ssp126_tot_monthly <- ipsl_ssp126_tot %>% 
  group_by(month,year) %>% 
  mutate(sum = sum(pcp)) %>% 
  select(month, year, sum) %>% 
  distinct()

ipsl_ssp126_tot_monthly$date <- format(as.Date(paste(ipsl_ssp126_tot_monthly$year, ipsl_ssp126_tot_monthly$month, 01), "%Y %m %d"), "%m-%Y")

ipsl_ssp126_tot_monthly$date <- my(ipsl_ssp126_tot_monthly$date)

# group by month (and associated year) sum of pcp
ipsl_ssp245_tot_monthly <- ipsl_ssp245_tot %>% 
  group_by(month,year) %>% 
  mutate(sum = sum(pcp)) %>% 
  select(month, year, sum) %>% 
  distinct()

ipsl_ssp245_tot_monthly$date <- format(as.Date(paste(ipsl_ssp245_tot_monthly$year, ipsl_ssp245_tot_monthly$month, 01), "%Y %m %d"), "%m-%Y")

ipsl_ssp245_tot_monthly$date <- my(ipsl_ssp245_tot_monthly$date)

# group by yearly sum of daily avg pcp 
ipsl_ssp370_tot_monthly <- ipsl_ssp370_tot %>% 
  group_by(month,year) %>% 
  mutate(sum = sum(pcp)) %>% 
  select(month, year, sum) %>% 
  distinct() 
  
ipsl_ssp370_tot_monthly$date <- format(as.Date(paste(ipsl_ssp370_tot_monthly$year, ipsl_ssp370_tot_monthly$month, 01), "%Y %m %d"), "%m-%Y")

ipsl_ssp370_tot_monthly$date <- my(ipsl_ssp370_tot_monthly$date)

# group by yearly sum of daily avg pcp 
ipsl_ssp585_tot_monthly <- ipsl_ssp585_tot %>% 
  group_by(month,year) %>% 
  mutate(sum = sum(pcp)) %>% 
  select(month, year, sum) %>% 
  distinct() 
  
ipsl_ssp585_tot_monthly$date <- format(as.Date(paste(ipsl_ssp585_tot_monthly$year, ipsl_ssp585_tot_monthly$month, 01), "%Y %m %d"), "%m-%Y")

ipsl_ssp585_tot_monthly$date <- my(ipsl_ssp585_tot_monthly$date)
```

## yearly total for all ssps and historical
```{r, fig.show='hide', message = FALSE, warning = FALSE, results = 'hide', error = TRUE}
## all three ssps 
ipsl_yearly_sum_proj <- 
  ggplot() +
  geom_line(data = ipsl_historical_tot_yearly, aes(x=year, y=sum, color="black"), size = 0.5) +
  geom_line(data = ipsl_ssp126_tot_yearly, aes(x=year, y=sum, color="orange"), size = 0.5) + 
  geom_line(data = ipsl_ssp245_tot_yearly, aes(x=year, y=sum, color="red"), size = 0.5) +
  geom_line(data = ipsl_ssp370_tot_yearly, aes(x=year, y=sum, color = "blue"), size = 0.5) +
  geom_line(data = ipsl_ssp585_tot_yearly, aes(x=year, y=sum, color = "seagreen"), size = 0.5) +
  theme_minimal() + 
  #scale_y_continuous(breaks=seq(0,450,50)) +
  scale_x_continuous(breaks=seq(1850,2100,50)) + 
  # scale_x_date(date_breaks = "5 years", date_labels = "%Y") +
  ggtitle("Oahu, HI Yearly Total Precipitation, IPSL-CM6A-LR: 1850-2100") + 
  scale_color_manual(values = c("black", "orange", "red", "blue", "seagreen"), labels = c("historical", "ssp126", "ssp245", "ssp370", "ssp585")) +
  labs(x = "Year",
       y = "Precipitation (in)") +
  geom_smooth(data = ipsl_historical_tot_yearly, aes(x=year, y=sum), method='lm', formula = y~x, color = "black") +
  geom_smooth(data = ipsl_ssp126_tot_yearly, aes(x=year, y=sum), method='lm', formula = y~x, color = "orange") + 
  geom_smooth(data = ipsl_ssp245_tot_yearly, aes(x=year, y=sum), method='lm', formula = y~x, color = "red") + 
  geom_smooth(data = ipsl_ssp370_tot_yearly, aes(x=year, y=sum), method='lm', formula = y~x, color = "blue") + 
  geom_smooth(data = ipsl_ssp585_tot_yearly, aes(x=year, y=sum), method='lm', formula = y~x, color = "seagreen") +
  theme(legend.title=element_blank())+
    theme(legend.position="bottom")

ipsl_yearly_sum_proj
```
## monthly totals 
```{r,fig.show='hide', message = FALSE, warning = FALSE, results = 'hide', error = TRUE}
# all three ssps 
ipsl_monthly_sum_proj <- 
  ggplot() +
  geom_line(data = ipsl_historical_tot_monthly, aes(x=date, y=sum, color="black"), size = 0.5) +
  geom_line(data = ipsl_ssp126_tot_monthly, aes(x=date, y=sum, color="orange"), size = 0.5) + 
  geom_line(data = ipsl_ssp245_tot_monthly, aes(x=date, y=sum, color="red"), size = 0.5) +
  geom_line(data = ipsl_ssp370_tot_monthly, aes(x=date, y=sum, color = "blue"), size = 0.5) +
  geom_line(data = ipsl_ssp585_tot_monthly, aes(x=date, y=sum, color = "seagreen"), size = 0.5) +
  theme_minimal() + 
  scale_y_continuous(breaks=seq(0,300,50)) +
  #scale_x_continuous(breaks=seq(1850,2100,50)) + 
 scale_x_date(date_breaks = "50 years", date_labels = "%Y") +
  ggtitle("Oahu, HI Monthly Total Precipitation, IPSL-CM6A-LR: 1850-2100") + 
  scale_color_manual(values = c("black", "orange", "red", "blue", "seagreen"), labels = c("historical", "ssp126", "ssp245", "ssp370", "ssp585")) +
  labs(x = "Year",
       y = "Precipitation (in)") +
  # geom_smooth(data = bcc_historical_tot_monthly, aes(x=date, y=sum), method='lm', formula = y~x, color = "black") +
  # geom_smooth(data = bcc_ssp126_tot_monthly, aes(x=date, y=sum), method='lm', formula = y~x, color = "orange") +
  # geom_smooth(data = bcc_ssp245_tot_monthly, aes(x=date, y=sum), method='lm', formula = y~x, color = "red") +
  # geom_smooth(data = bcc_ssp370_tot_monthly, aes(x=date, y=sum), method='lm', formula = y~x, color = "blue") +
  # geom_smooth(data = bcc_ssp585_tot_monthly, aes(x=date, y=sum), method='lm', formula = y~x, color = "seagreen") +
  theme(legend.title=element_blank())+
    theme(legend.position="bottom")
  
  # stat_regline_equation(label.y = 200) +
  # stat_cor(label.y = 190)

ipsl_monthly_sum_proj
```
## separate historical total precip based on 30 yr time periods
```{r, fig.show='hide', message = FALSE, warning = FALSE, results = 'hide', error = TRUE}
ipsl_historical_tot_1984_2014 <- ipsl_historical_tot %>% 
  filter(year %in% (1984:2014))
  
## separate projections based on 2020 to 2070
ipsl_ssp126_tot_2020_2050 <- ipsl_ssp126_tot %>% 
  filter(year %in% (2020:2050))

ipsl_ssp245_tot_2020_2050 <- ipsl_ssp245_tot %>% 
  filter(year %in% (2020:2050))

ipsl_ssp370_tot_2020_2050 <- ipsl_ssp370_tot %>% 
  filter(year %in% (2020:2050))

ipsl_ssp585_tot_2020_2050 <- ipsl_ssp585_tot %>% 
  filter(year %in% (2020:2050))

ipsl_daily_tot_period <- 
  ggplot() +
   geom_line(data = ipsl_historical_tot_1984_2014, aes(x=date, y=pcp, color="black"), size = 0.5) + 
  geom_line(data = ipsl_ssp126_tot_2020_2050, aes(x=date, y=pcp, color="orange"), size = 0.5) + 
  geom_line(data = ipsl_ssp245_tot_2020_2050, aes(x=date, y=pcp, color="red"), size = 0.5) +
  geom_line(data = ipsl_ssp370_tot_2020_2050, aes(x=date, y=pcp, color = "blue"), size = 0.5) +
  geom_line(data = ipsl_ssp585_tot_2020_2050, aes(x=date, y=pcp, color = "seagreen"), size = 0.5) + 
  theme_minimal() + 
  scale_y_continuous(breaks=seq(0,100,10), limits = c(0, 100)) +
  scale_x_date(date_breaks = "3 years", date_labels = "%Y") +
  ggtitle("Oahu, HI Daily Total Precipitation, IPSL-CM6A-LR: 1984-2050") +
   labs(x = "Year",
       y = "Precipitation (in)") +
  scale_color_manual(values = c("black", "orange", "red", "blue", "seagreen"), labels = c("historical", "spp126", "ssp245", "ssp370", "ssp585")) +
   theme(legend.title=element_blank())+
    theme(legend.position="bottom") +
    theme(text = element_text(size=14))

ipsl_daily_tot_period

# ggsave('ipsl_daily_tot_period.png', ipsl_daily_tot_period, width = 12, height = 8, units = "in")
```
## historical 50 year period graph
```{r, fig.show='hide', message = FALSE, warning = FALSE, results = 'hide', error = TRUE}
ipsl_daily_tot_period_hist <- 
  ggplot() +
  geom_line(data = ipsl_historical_tot_1984_2014, aes(x=date, y=pcp, color="black"), size = 0.5) +  
  theme_minimal() + 
  scale_y_continuous(breaks=seq(0,50,10)) +
  scale_x_date(date_breaks = "3.5 years", date_labels = "%Y") +
  ggtitle("Oahu, HI Daily Total Precipitation, IPSL-CM6A-LR, historical: 1984-2014 ") +
   labs(x = "Year",
       y = "Precipitation (in)") +
  scale_color_manual(values = c("black"), labels = c("historical")) + 
 theme(legend.title=element_blank()) +
    theme(legend.position="bottom")

ipsl_daily_tot_period_hist
```
## ratio of daily total precipitation in the future vs. historical periods
```{r, fig.show='hide', message = FALSE, warning = FALSE, results = 'hide', error = TRUE}
## merge the data frames together 
ipsl_daily_tot_prec_merge1 <- ipsl_ssp126_tot_2020_2050 %>% right_join(ipsl_ssp245_tot_2020_2050, by = c("date")) 
ipsl_daily_tot_prec_merge2 <- ipsl_daily_tot_prec_merge1 %>%  right_join(ipsl_ssp370_tot_2020_2050, by = c("date"))
ipsl_daily_tot_prec_merge_fin <- ipsl_daily_tot_prec_merge2 %>% right_join(ipsl_ssp585_tot_2020_2050,by = c("date")) %>% 
  select(date, year.x, month.x, day.x, pcp.x, pcp.y, pcp.x.x, pcp.y.y) %>% 
  rename(year = year.x,
         month = month.x,
         day = day.x,
         ssp126_pcp=pcp.x,
         ssp245_pcp=pcp.y,
         ssp370_pcp = pcp.x.x ,
         ssp585_pcp = pcp.y.y )

ipsl_historical_tot_1984_2014_rename <- ipsl_historical_tot_1984_2014 %>% 
  rename(hist_date = date,
         hist_pcp = pcp,
         hist_year = year,
         hist_month = month,
         hist_day = day)

ipsl_merge_his_proj <- cbind(ipsl_daily_tot_prec_merge_fin, ipsl_historical_tot_1984_2014_rename) 

ipsl_ratio_df <- ipsl_merge_his_proj %>% 
  mutate(ssp126_hist = ssp126_pcp/hist_pcp,
         ssp245_hist = ssp245_pcp/hist_pcp,
         ssp370_hist = ssp370_pcp/hist_pcp,
         ssp585_hist = ssp585_pcp/hist_pcp) %>% 
  select(date, ssp126_hist,ssp245_hist, ssp370_hist, ssp585_hist) %>% 
  pivot_longer(cols = ssp126_hist:ssp585_hist,
               names_to = c("ssp"),
               values_to = "fut_hist_ratio")

```

## March 14, 2009 = Wailupe storm that we will use to do CC analysis with. 
```{r, fig.show='hide', message = FALSE, warning = FALSE, results = 'hide', error = TRUE}
ipsl_merge_his_proj_filt_mar14 <- ipsl_merge_his_proj %>%
  filter(month == "3") %>%
  filter(day == "14") %>%
  group_by(month,day) %>%
  mutate(ssp126_pcp_avg = mean(ssp126_pcp),
         ssp245_pcp_avg = mean(ssp245_pcp),
         ssp370_pcp_avg = mean(ssp370_pcp),
         ssp585_pcp_avg = mean(ssp585_pcp),
         hist_pcp_avg = mean(hist_pcp)) %>%
  select(month,day,ssp126_pcp_avg,ssp245_pcp_avg,ssp370_pcp_avg, ssp585_pcp_avg, hist_pcp_avg ) %>%
  distinct()


ipsl_merge_his_proj_filt_mar14 <- ipsl_merge_his_proj_filt_mar14 %>%
  mutate(ssp126_hist = ssp126_pcp_avg/hist_pcp_avg,
         ssp245_hist = ssp245_pcp_avg/hist_pcp_avg,
         ssp370_hist = ssp370_pcp_avg/hist_pcp_avg,
         ssp585_hist = ssp585_pcp_avg/hist_pcp_avg) %>%
  select(month, day, ssp126_hist,ssp245_hist, ssp370_hist, ssp585_hist) %>%
  pivot_longer(cols = ssp126_hist:ssp585_hist,
               names_to = c("ssp"),
               values_to = "fut_hist_ratio")

proj_hist_mar14_ipsl <- ggplot(data = ipsl_merge_his_proj_filt_mar14, aes(x=ssp, y=fut_hist_ratio)) +
  geom_point(size=2) +
  theme_minimal() +
  labs(x="Shared Socioeconomic Pathways (ssp)",
       y="Future Projection/Historical Daily Total Average Ratio (Mar 14)",
       caption = "Climate Model: IPSL-CM6A-LR") +
    theme(text = element_text(size=15)) +
  scale_x_discrete(labels=c("ssp126_hist" = "ssp 1-2.6",
                            "ssp245_hist" = "ssp 2-4.5",
                              "ssp370_hist" = "ssp 3-7.0",
                            "ssp585_hist" = "ssp 5-8.5")) + 
  scale_y_continuous(limits = c(0,3.5))

proj_hist_mar14_ipsl

# ggsave('proj_hist_mar14_ipsll.png', proj_hist_mar14_ipsl, width = 12, height = 10, units = "in")

```


## merging all climate model future/historical ratios for March 14th storm (note: you will need to have run climate_change_analysis.Rmd for all climate models) to plot 
```{r, fig.show='hide', message = FALSE, warning = FALSE, results = 'hide', error = TRUE}
futhis_ratio_combine_mar14 <- merge_his_proj_filt_mar14 %>%
  rbind(bcc_merge_his_proj_filt_mar14, ipsl_merge_his_proj_filt_mar14) %>% 
  mutate(model = c("CNRM"))

futhis_ratio_combine_mar14$model[c(5:8)] = "BCC"
futhis_ratio_combine_mar14$model[c(9:12)] = "IPSL"

cbp2 <- c("#000000", "#009E73",
           "#D55E00")

combine_ratio_plot_mar14 <- ggplot(data = futhis_ratio_combine_mar14, aes(x=ssp, y=fut_hist_ratio)) +
  geom_point(aes(color=model), size =6)+
  theme_classic() +
  labs(x="Shared Socioeconomic Pathways (SSP)",
       y="Multiplicative Change Factor (MCF)") +
  ggtitle("March 14th Wailupe Storm Event") +
    theme(text = element_text(size=22)) +
  scale_x_discrete(labels=c("ssp126_hist" = "SSP 1-2.6",
                            "ssp245_hist" = "SSP 2-4.5",
                              "ssp370_hist" = "SSP 3-7.0",
                            "ssp585_hist" = "SSP 5-8.5")) + 
 scale_y_continuous(breaks=(seq(0, 3.5, .5)), limits = c(0, 3.5))  +
  guides(color=guide_legend("CMIP6 Model"))  +
    theme(legend.position="bottom") +
   scale_colour_manual(labels = c("BCC-CSM2-MR", "CNRM-ESM2-1", "IPSL-CM6A-LR"), values=cbp2) +
  theme(text=element_text(color="black"),axis.text=element_text(color="black")) +
  theme(plot.title = element_text(hjust = 0.5))

combine_ratio_plot_mar14

# ggsave('combine_ratio_plot_mar14_presentation.png', combine_ratio_plot_mar14, width = 16, height = 9, units = "in")

```
